import re
import sys

input = '''
line1
          echo ::set-env name=FOO_BAR::$FOO_BAR
          echo ::set-env name=FOO_BAR::${FOO_BAR}
          echo "::set-env name=FOO_BAR::${FOO_BAR}"
          echo "::set-env name=FOO_BAR::$FOO_BAR"
line3
'''

should = '''
line1
          echo "FOO_BAR=$FOO_BAR" >> $GITHUB_ENV
          echo "FOO_BAR=$FOO_BAR" >> $GITHUB_ENV
          echo "FOO_BAR=$FOO_BAR" >> $GITHUB_ENV
          echo "FOO_BAR=$FOO_BAR" >> $GITHUB_ENV
line3
'''

def fix_set_env(input):
    def updater(match):
        match1, match2 = match.groups()
        name = match2.strip('{}"')
        if match1 != name:
            print(f'### unsure, {match1} != {name}')
            return match.group(0)
        ret = '"%s=${%s}" >> $GITHUB_ENV' % (name, name)
        print('### Update: %s --> %s' % (match.group(0), ret))
        return ret
    return re.sub(r'"?::set-env\s+name=(\S+?)::\$([\S}"]+)', updater, input)

def test():
    result = fix_set_env(input)
    assert result == should, result

test()

text = fix_set_env(open(sys.argv[1]).read())
with open(sys.argv[1], 'wt') as fd:
    fd.write(text)

